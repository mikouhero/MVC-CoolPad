# 优化器

多种执行策略可实现目标，系统自动选择最优进行执行。


### 成本

- IO成本  
   数据存储在硬盘上，我们想要进行某个操作需要将其加载到内存中，这个过程的时间被称为I/O成本。默认是1。
 
- CPU成本     
   内存对结果集进行排序的时间被称为CPU成本。默认是0.2。
   
### 单表查询的成本

先来建一个用户表dev_user，里面包括主键id，用户名username，密码password，外键user_info_id，状态status，外键main_station_id，是否外网访问visit，这七个字段。索引有两个，一个是主键的聚簇索引，另一个是显式添加的以username为字段的唯一索引uname_unique。

![](https://user-gold-cdn.xitu.io/2019/12/25/16f3b9737cd2a994)

执行 `select * from dev_user where username='XX'` 计算成本

##### 计算全表扫描的代价     
 我们通过show table status like ‘dev_user’命令知道`rows`和`data_length`字段，如下图。   
 ![](https://user-gold-cdn.xitu.io/2019/12/25/16f3bb9f9d3c2fb5)
 
 row: 表示表中的记录条数,但是这个数据不准确 是个估计值     
 data_length :表示占用的存储空间字节数  
 `data_length=聚簇索引的页面数量X每个页面的大小`    
 反推页数量 =  1589248÷16÷1024=97    
 IO 成本 ：97x1= 97    
 CPU 成本 ： 6141X0.2=1228 
 总成本：97+1228=1325   
 
#####  计算使用不同索引执行查询的代价
因为要查询出满足条件的所有字段信息，所以要考虑回表成本。    
I/O成本=1+1X1=2(范围区间的数量+预计二级记录索引条数)   
CPU成本=1X0.2+1X0.2=0.4(读取二级索引的成本+回表聚簇索引的成本)  
总成本=I/O成本+CPU成本=2.4 
 
 
### 多表查询的成本 
对于两表连接查询来说，他的查询成本由下面两个部分构成：     
 + 单次查询驱动表的成本  
 + 多次查询被驱动表的成本（具体查询多次取决于对驱动表查询的结果集有多少个记录）

### index dive

 如果前面的搜索条件不是等值，而是区间，如select * from dev_user where username>'admin' and username<'test'这个时候我们是无法看出需要回表的数量。
 + 步骤1：先根据username>'admin'这个条件找到第一条记录，称为区间最左记录。       
 + 步骤2：再根据username<'test'这个条件找到最后一条记录，称为区间最右记录。       
 + 步骤3：如果区间最左记录和区间最右记录相差不是很远，可以准确统计出需要回表的数量。 如果相差很远，就先计算10页有多少条记录，再乘以页面数量，最终模糊统计出来。

