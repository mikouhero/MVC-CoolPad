# 如何解决缓存与数据库的数据一致性问题

- 缓存与数据库的数据不一致的原因：
> 多个请求的执行顺序不同导致脏数据 ，更新时正好有读请求 读请求取到旧数据然后更新缓存  
  数据库是读写分离的 在主库更新完之后 需要一定的时间从库才能更新    
  
  ### 1、先更新数据库 后更新缓存  
  
  > 两个写请求A B ,A先更新数据库,B后更新数据库 ，但是B可能先更新缓存 A后更新缓存 ，这样就
  会导致缓存里面的是旧数据    
  更新缓存时失败也有可能导致缓存的是旧数据    
  
  ### 2、先删除缓存  在更新数据库
  
 > 删除缓存后 更新数据库之前假如正好有读请求 读请求把旧数据设置到缓存了
 
 
 ### 3 先更新数据库 在删除缓存 
 > 更新后删除缓存时 网络不好 删除失败也有可能导致缓存的是旧数据 
 
 
 ## 正确的方案
 
 #### 写请求串行化 
 >  将写请求更新之前先获取分布式锁 获得之后才能更新 这样实现请求的串行化，导致会导致效率变低
 
 ### 先更新数据库 异步删除缓存 删除失败后重试 
 >  先更新数据库 异步删除缓存 删除缓存失败时 继续异步重试，或者将操作放到消息队列中 ，再进行删除操作
 如果数据库是读写分离的，那么删除缓存时需要延迟删除，否则可能会在删除缓存时，从库还没有收到更新后的数据，其他读请求就去从库读到旧数据然后设置到缓存中。
 ![](http://notfound9.github.io/interviewGuide/static/o_update1.png)
 
 ### 业务项目更新数据库 其他项目订阅binlog 更新 
 
 > 业务项目直接更新数据库 然后其他项目订阅binlig  接收到数据库操作的消息后 更新缓存 更新缓存失败时，
 新建异步线程去重试挥着将操作发到消息队列 然后继续执行处理 但是这种方案更新mysql 还是有一定的延迟 缓冲中才是新值
 
 ![](http://notfound9.github.io/interviewGuide/static/o_update2-20200419221055438.png)
 
 
  
 
